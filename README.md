# WEBアプリケーション雛形 (作成中)
![ESLint](https://github.com/yokotani92/my-app/workflows/ESLint/badge.svg)
![Jest](https://github.com/yokotani92/my-app/workflows/Jest/badge.svg)

## 構成
- Server-side: Golang ([Gorilla Web Toolkit](https://github.com/gorilla), [SQLX](https://github.com/jmoiron/sqlx))
- Client-side: React ([TypeScript](https://www.typescriptlang.org/), [Next.js](https://nextjs.org/), [Redux Toolkit](https://redux-toolkit.js.org/), [Material UI](https://material-ui.com/), [React Hook Form](https://react-hook-form.com/))
- Database: Postgres
- Others:
  - Docker-based local development environment
  - API definition in the format of OpenAPI 3.0
  - API client libraries and Server stubs are generated by the [OpenAPI Generator](https://github.com/OpenAPITools/openapi-generator)
    - Client: [typescript-axios](https://github.com/OpenAPITools/openapi-generator/blob/master/docs/generators/typescript-axios.md)
    - Server: [go-server](https://github.com/OpenAPITools/openapi-generator/blob/master/docs/generators/go-server.md)
  - User authentication by the [OpenID Connect](https://openid.net/connect/)

Application Server (Go), Web Server (NGINX), Reverse Proxy Server (NGINX), DB はそれぞれ Docker コンテナで用意している。同一ネットワークで実行するため `docker-compose` で起動させる。

## メモ
### 単体の起動
- GolangのAPIサーバーは `golang` ディレクトリから以下で起動
  ```bash
  go run main.go
  ```
- Reactアプリケーションは `react` ディレクトリから以下で起動
  ```bash
  npm run dev
  ```

### 開発環境用コンテナの起動（開発時は基本的にこちらを推奨）
- 事前準備（この手順を踏まないとコンテナが起動しない）
  - `mkcert` によって localhost 用の `localhost.pem` と `localhost-key.pem` を作成する。 [[参考](https://qiita.com/rkunihiro/items/530b5dc685bd3bff2082)]
  ```bash
  brew install mkcert // 未インストールの場合のみ
  mkcert --install
  mkcert localhost
  ```
  - 作成した `pem` ファイル `localhost.pem`, `localhost-key.pem` を `./nginx` 下に置く。これで NGINX のリバースプロキシサーバー `https://localhost` に `https` 接続できるようになる。（クライアントサーバー `http://localhost:3000` は `express` で用意しており、こちらは `https` 接続できないので注意。またその影響で CORS 制限があり、API も利用できないようになっている。）
- 開発環境を起動する際は `root` で以下を実行
    ```bash
    docker-compose build
    docker-compose up -d
    ```
  - 立ち上がったら https://localhost にアクセスする
    - 起動状況を確認するために Docker Desktop があると便利
  - サーバー・クライアントともに保存で再ビルドされ、コンテナを立ち上げなおさずともホットリロードで反映される


- 開発環境を終了する際は以下を実行
  ```bash
  docker-compose down
  ```

### デプロイ用コンテナの起動
- `.env.example` を参考に `.env` ファイルを用意する。Postgres の情報と OpenID Connect の情報、どちらとも正しい情報に書き換える必要がある。OpenID Connect については Google アカウントによる認証を想定している。詳しくは `auth_api.go` を参照。
- 現在の API の設計上、OpenID による認証を有効にするとき、Google の認証情報設定でリダイレクトURLのパスは `api/auth/callback` にする必要がある。
- 以下を実行する。  
  ```bash
  docker-compose -f docker-compose.prod.yml up -d
  ```
  デプロイ用コンテナでは Go のビルド、Next.js の静的ファイル出力が行われる。

